name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # Job 1: Secret Scanning
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --only-verified

      - name: Check for common secret patterns
        run: |
          echo "Scanning for common secret patterns in committed files..."
          
          # Get the commit range - check commits being pushed
          if [ "${{ github.event_name }}" == "push" ]; then
            # For push events, check commits being pushed
            if [ -n "${{ github.event.before }}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
              COMMIT_RANGE="${{ github.event.before }}..${{ github.event.after }}"
            else
              # First commit or single commit push
              COMMIT_RANGE="${{ github.event.after }}"
            fi
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PR events, check commits in the PR
            COMMIT_RANGE="${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }}"
          else
            # For other events, check last commit
            COMMIT_RANGE="HEAD~1..HEAD"
          fi
          
          echo "Checking commit range: $COMMIT_RANGE"
          
          # Get list of files changed in the commit(s)
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRT $COMMIT_RANGE 2>/dev/null || git show --name-only --format="" $COMMIT_RANGE 2>/dev/null || echo "")
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No files changed to check"
            exit 0
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check if config.json is in the changed files
          if echo "$CHANGED_FILES" | grep -q "^config.json$"; then
            echo "ERROR: config.json should not be committed!"
            echo "Please ensure config.json is in .gitignore and remove it from git if it was previously tracked."
            exit 1
          fi
          
          # Check if .env files are in the changed files
          if echo "$CHANGED_FILES" | grep -q "\.env$"; then
            echo "ERROR: .env files should not be committed!"
            exit 1
          fi
          
          # Check for hardcoded API keys in changed files
          SECRET_FOUND=false
          for file in $CHANGED_FILES; do
            # Skip if file doesn't exist or is binary
            if [ ! -f "$file" ]; then
              continue
            fi
            
            # Check for API key patterns in the file
            if grep -q "sk-proj-" "$file" 2>/dev/null; then
              echo "ERROR: Potential API key found in $file!"
              SECRET_FOUND=true
            fi
            
            # Check for other common secret patterns
            if grep -qiE "(api[_-]?key|secret|password|token)\s*[:=]\s*['\"]?sk-" "$file" 2>/dev/null; then
              echo "ERROR: Potential secret found in $file!"
              SECRET_FOUND=true
            fi
          done
          
          if [ "$SECRET_FOUND" = true ]; then
            exit 1
          fi
          
          echo "‚úì No secrets detected in committed files"

  # Job 2: Build & Validate
  build:
    name: Build & Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Check required files exist
        run: |
          echo "Checking required files..."
          required_files=("server.js" "package.json" "index.html" "script.js" "styles.css" "questions.csv")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "ERROR: Required file $file is missing!"
              exit 1
            fi
            echo "‚úì $file exists"
          done

      - name: Validate Node.js syntax
        run: |
          echo "Validating Node.js syntax..."
          node --check server.js || exit 1
          echo "‚úì server.js syntax is valid"
          node --check script.js 2>/dev/null || echo "Note: script.js is client-side JavaScript"

      - name: Validate package.json
        run: |
          echo "Validating package.json..."
          node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))" || exit 1
          echo "‚úì package.json is valid JSON"

      - name: Verify config.json.example exists
        run: |
          if [ ! -f "config.json.example" ]; then
            echo "ERROR: config.json.example is missing!"
            exit 1
          fi
          echo "‚úì config.json.example exists"

      - name: Test server startup (dry run)
        env:
          OPENAI_API_KEY: test-key-placeholder
          PORT: 3000
        run: |
          echo "Testing server initialization..."
          timeout 5 node server.js || true
          echo "‚úì Server can start (timeout expected)"

  # Job 3: Deploy (only on push to main/master)
  deploy:
    name: Deploy to Production
    needs: [secret-scan, build]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then
            echo "‚ö†Ô∏è  Render deployment skipped: RENDER_API_KEY or RENDER_SERVICE_ID not configured"
            echo "To enable Render deployment:"
            echo "1. Get your API key from https://dashboard.render.com/account/api-keys"
            echo "2. Get your service ID from your Render dashboard"
            echo "3. Add them as GitHub secrets: RENDER_API_KEY and RENDER_SERVICE_ID"
            exit 0
          fi
          
          echo "Deploying to Render..."
          curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Accept: application/json"
          echo "‚úì Deployment triggered on Render"

      - name: Deployment Status
        run: |
          echo "üöÄ Deployment pipeline completed successfully!"
          echo "If Render deployment is configured, your service will be updated shortly."

